<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Visitas</title>
</head>

<body>
    <div th:replace="~{fragments :: navbar}"></div>

    <div class="container mt-4">
        <h2 class="mb-4">Gestión de Visitas</h2>

        <!-- Sección para supervisor -->
        <div th:if="${rol == 'SUPERVISOR' or rol == 'ADMIN'}">
            <a class="btn btn-primary mb-3" th:href="@{/visits/crear}">Crear nueva visita</a>
        </div>

        <!-- Filtros por estado -->
        <form method="get" th:action="@{/visitas}" class="mb-3" th:if="${rol != 'TECNICO'}">
            <button type="submit" name="estado" value="" class="btn me-2"
                th:classappend="${#strings.isEmpty(param.estado)} ? 'btn-outline-secondary active' : 'btn-outline-secondary'">Todos</button>

            <button type="submit" name="estado" value="PLANNED" class="btn me-2"
                th:classappend="${param.estado == 'PLANNED'} ? 'btn-outline-primary active' : 'btn-outline-primary'">Planned</button>

            <button type="submit" name="estado" value="STARTED" class="btn me-2"
                th:classappend="${param.estado == 'STARTED'} ? 'btn-outline-warning active' : 'btn-outline-warning'">Started</button>

            <button type="submit" name="estado" value="DONE" class="btn me-2"
                th:classappend="${param.estado == 'DONE'} ? 'btn-outline-success active' : 'btn-outline-success'">Done</button>
        </form>

        <!-- Tabla de visitas -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th data-sort-key="customer">Cliente</th>
                    <th data-sort-key="technician">Técnico</th>
                    <th data-sort-key="date">Fecha Creada</th>
                    <th data-sort-key="state">Estado</th>
                    <th data-sort-key="actions">Acciones</th>
                    <th data-sort-key="purpose">Propósito</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="visita : ${visitas}">
                    <td th:text="${visita.customerName}">Cliente</td>
                    <td th:text="${visita.technicianName}">Técnico</td>
                    <td th:text="${#temporals.format(visita.createdAt, 'yyyy-MM-dd')}"></td>
                    <td th:text="${visita.state}">Estado</td>
                    <td th:text="${visita.purpose}">Propósito</td>
                    <td>
                        <a th:href="@{'/visitas/' + ${visita.id}}" class="btn btn-info btn-sm">Ver</a>

                        <button th:if="${rol == 'TECNICO' and visita.state == 'PLANNED'}"
                            th:attr="onclick='location.href=\'/visitas/' + ${visita.id} + '/checkin\''"
                            class="btn btn-sm btn-success">Check-in</button>

                        <button th:if="${rol == 'TECNICO' and visita.state == 'STARTED'}"
                            th:attr="onclick='location.href=\'/visitas/' + ${visita.id} + '/complete\''"
                            class="btn btn-sm btn-warning">Completar</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const table = document.querySelector('table.table');
            if (!table) return;
            const getValue = (row, index) => row.cells[index].textContent.trim();
            const parseDate = (value) => new Date(value + 'T00:00:00');
            table.querySelectorAll('th[data-sort-key]').forEach((th, index) => {
                th.style.cursor = 'pointer';
                let asc = true;
                th.addEventListener('click', () => {
                    const rows = Array.from(table.tBodies[0].rows);
                    const isDate = th.dataset.sortKey === 'date';
                    rows.sort((a, b) => {
                        const aVal = getValue(a, index);
                        const bVal = getValue(b, index);
                        if (isDate) {
                            return asc ? parseDate(aVal) - parseDate(bVal) : parseDate(bVal) - parseDate(aVal);
                        }
                        return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    });
                    asc = !asc;
                    rows.forEach(row => table.tBodies[0].appendChild(row));
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
