<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Visitas</title>
</head>

<body>
    <div th:replace="~{fragments :: navbar}"></div>

    <div class="container mt-4">
        <h2 class="mb-4">Gestión de Visitas</h2>

        <!-- Sección para supervisor -->
        <div th:if="${rol == 'SUPERVISOR' or rol == 'ADMIN'}">
            <a class="btn btn-primary mb-3" th:href="@{/visits/crear}">Crear nueva visita</a>
        </div>

        <!-- Filtros por estado -->
        <form method="get" th:action="@{/visitas}" class="mb-3">
            <button type="submit" name="estado" value="" class="btn me-2"
                th:classappend="${#strings.isEmpty(param.estado)} ? 'btn-outline-secondary active' : 'btn-outline-secondary'">Todos</button>

            <button type="submit" name="estado" value="PLANNED" class="btn me-2"
                th:classappend="${param.estado == 'PLANNED'} ? 'btn-outline-primary active' : 'btn-outline-primary'">Planned</button>

            <button type="submit" name="estado" value="STARTED" class="btn me-2"
                th:classappend="${param.estado == 'STARTED'} ? 'btn-outline-warning active' : 'btn-outline-warning'">Started</button>

            <button type="submit" name="estado" value="DONE" class="btn me-2"
                th:classappend="${param.estado == 'DONE'} ? 'btn-outline-success active' : 'btn-outline-success'">Done</button>
        </form>

        <!-- Tabla de visitas -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Técnico</th>
                    <th>Fecha Creada</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                    <th>Propósito</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="visita : ${visitas}">
                    <td th:text="${visita.customerName}">Cliente</td>
                    <td th:text="${visita.technicianName}">Técnico</td>
                    <td th:text="${#temporals.format(visita.createdAt, 'yyyy-MM-dd')}"></td>
                    <td th:text="${visita.state}">Estado</td>
                    <td th:text="${visita.purpose}">Propósito</td>
                    <td>
                        <a th:href="@{'/visitas/' + ${visita.id}}" class="btn btn-info btn-sm">Ver</a>

                        <button th:if="${rol == 'TECNICO' and visita.state == 'SCHEDULED'}"
                            th:attr="onclick='location.href=\'/visitas/' + ${visita.id} + '/checkin\''"
                            class="btn btn-sm btn-success">Check-in</button>

                        <button th:if="${rol == 'TECNICO' and visita.state == 'STARTED'}"
                            th:attr="onclick='location.href=\'/visitas/' + ${visita.id} + '/complete\''"
                            class="btn btn-sm btn-warning">Completar</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>