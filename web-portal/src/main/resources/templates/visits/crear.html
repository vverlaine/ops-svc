<!-- crear.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Crear Visita</title>
</head>

<body>
    <div th:replace="~{fragments :: navbar}"></div>

    <div class="container mt-4">
        <h2>Crear Visita</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                Nueva visita
            </div>
            <div class="card-body">
        <form th:action="@{/visits/crear}" th:object="${visita}" method="post" class="row g-3">
            <div class="col-12">
                <label class="form-label fw-semibold">Cliente</label>
                <select th:field="*{customerId}" class="form-select" id="customerSelect">
                    <option value="">Seleccione un cliente</option>
                    <option th:each="c : ${clientes}"
                            th:value="${c['id']}"
                            th:text="${c['name']}"
                            th:data-address="${c['address']}"
                            th:data-phone="${c['phone']}">
                    </option>
                </select>
            </div>
            <div class="col-12">
                <label class="form-label fw-semibold">Dirección del cliente</label>
                <textarea class="form-control" id="customerAddress" readonly rows="2" placeholder="Selecciona un cliente"></textarea>
            </div>

            <div class="col-md-6">
                <label for="priority" class="form-label fw-semibold">Prioridad</label>
                <select id="priority" name="priority" class="form-select" required>
                    <option value="LOW">Baja</option>
                    <option value="MEDIUM" selected>Media</option>
                    <option value="HIGH">Alta</option>
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Técnico asignado</label>
                <select th:field="*{technicianId}" class="form-select">
                    <option value="">Seleccione un técnico</option>
                    <option th:each="t : ${tecnicos}"
                            th:value="${t['id']}"
                            th:text="${(t['userName'] != null ? t['userName'] : 'Sin nombre') + (t['active'] == true ? '' : ' - Inactivo')}">
                    </option>
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold">Fecha programada</label>
                <input type="date" id="scheduledStartDate" th:field="*{scheduledStartDate}" class="form-control" />
            </div>

            <div class="col-md-6 d-none">
                <input type="hidden" id="scheduledStartAt" th:field="*{scheduledStartAt}" />
                <input type="hidden" id="scheduledEndAt" th:field="*{scheduledEndAt}" />
                <input type="hidden" id="siteId" th:field="*{siteId}" />
            </div>

            <div class="col-12">
                <label for="purpose" class="form-label fw-semibold">Propósito</label>
                <select id="purpose" name="purpose" class="form-select">
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Instalación">Instalación</option>
                    <option value="Reparación">Reparación</option>
                    <option value="Inspección">Inspección</option>
                </select>
            </div>

            <div class="col-12">
                <label for="notesPlanned" class="form-label fw-semibold">Notas (opcional)</label>
                <textarea id="notesPlanned" th:field="*{notesPlanned}" class="form-control" rows="3"></textarea>
            </div>

            <div class="col-12 d-flex justify-content-between flex-wrap gap-2">
                <a href="/visitas" class="btn btn-outline-secondary">← Regresar</a>
                <button type="submit" class="btn btn-primary px-4">Crear visita</button>
            </div>
        </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const select = document.getElementById('customerSelect');
            const addressField = document.getElementById('customerAddress');
            const startHidden = document.getElementById('scheduledStartAt');
            const endHidden = document.getElementById('scheduledEndAt');
            const siteHidden = document.getElementById('siteId');
            const dateField = document.getElementById('scheduledStartDate');

            function updateAddress() {
                const option = select.options[select.selectedIndex];
                const address = option ? option.getAttribute('data-address') : '';
                addressField.value = address || '';
                if (option && option.value) {
                    siteHidden.value = option.value;
                }
            }

            function syncDates() {
                if (!dateField.value) {
                    startHidden.value = '';
                    endHidden.value = '';
                    return;
                }
                startHidden.value = `${dateField.value}T00:00`;
                endHidden.value = `${dateField.value}T02:00`;
            }

            dateField.addEventListener('change', syncDates);
            select.addEventListener('change', updateAddress);
            updateAddress();
            syncDates();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
